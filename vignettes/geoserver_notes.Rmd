---
title: "geoserver_notes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{geoserver_notes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(store)
```

These notes were written whilst scoping work to use geoserver to deliver spatial data into a leaflet map, within a shiny app.

## Resources

### Packages

-   [httr](https://httr.r-lib.org/index.html)

-   [Leaflet for R](https://rstudio.github.io/leaflet/)

### Tutorials

-   [Using WMS services in R](https://inbo.github.io/tutorials/tutorials/spatial_wms_services/)

-   [Using WFS services in R](https://inbo.github.io/tutorials/tutorials/spatial_wfs_services/#useful-overviews-of-web-feature-services)

-   [EMODnet web service documentation](https://emodnet.ec.europa.eu/en/emodnet-web-service-documentation#r-tutorial)

### Stackoverflow

-   [Loading WMS layer in R leaflet using addWMSTiles](https://stackoverflow.com/questions/32960050/loading-wms-layer-in-r-leaflet-using-addwmstiles)

-   [Enable WMS GetFeatureInfo request in Leaflet using R?](https://gis.stackexchange.com/questions/334004/enable-wms-getfeatureinfo-request-in-leaflet-using-r)

-   [How to display WMS legends based on layer groups in Leaflet for R?](https://stackoverflow.com/questions/44006074/how-to-display-wms-legends-based-on-layer-groups-in-leaflet-for-r)

```{r}
library(httr)
```

## Service URL

[Marine Protected Area Mapper](https://jncc.gov.uk/our-work/marine-protected-area-mapper/)

```{r}
wms_mpa_mapper <- "https://mpa-ows.jncc.gov.uk/mpa_mapper/wms"
```

## Get capabilities

### Send request

Build and send a request using the httr package to geoserver, returning a response from geoserver.

```{r}
response <- GET(wms_mpa_mapper,
                query = list(service = "wms",
                             version = "1.3.0",
                             request = "GetCapabilities"))
response
```

### Check request status 

Check successful request status = 200 and either warn or stop if request was unsuccessful

```{r}
http_status(response)
status_code(response)

warn_for_status(response)
stop_for_status(response)
```

### Read response content

```{r}
content <- content(response, as = "parsed", type = "text/xml", encoding = "UTF-8")
```

### Leaflet

```{r}
library(leaflet)
leaflet() |> 
  setView(lng = -1, lat = 55, zoom = 4) |> 
  addTiles(group = "OSM") |>
  addWMSTiles(
    wms_mpa_mapper,
    layers = "sac_mc_full",
    options = WMSTileOptions(format = "image/png",
                             transparent = TRUE)
  ) |>
  addWMSTiles(
    wms_mpa_mapper,
    layers = "spa_mc_full",
    options = WMSTileOptions(format = "image/png",
                             transparent = TRUE)
  )
```

```{r}
library(leaflet)
library(leaflet.extras2)
leaflet() |> 
  setView(lng = -1, lat = 55, zoom = 4) |> 
  addTiles(group = "OSM") |>
  addWMS(baseUrl = "https://mpa-ows.jncc.gov.uk/mpa_mapper/wms",
         layers = c("sac_mc_full", "spa_mc_full"),
         group = "wmsgroup",
         options = leaflet::WMSTileOptions(
           transparent = TRUE,
           format = "image/png",
           info_format = "text/html",
           tiled = FALSE
         )) |> 
  addLayersControl(baseGroups = "base",
                   overlayGroups = c("sac_mc_full", "spa_mc_full"))
```
