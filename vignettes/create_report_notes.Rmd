---
title: "Create R Markdown reports"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Create R Markdown reports}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

This document goes through the R Markdown scripts used to split and output data both 
within a single report and across multiple reports. 

This example generates a report for each penguin species' measurements, taken at 
each of their locations, with the measurements split by the year within each report.
The penguin measurements are taken from the palmerpenguins package's penguin dataset. 

Creating the reports requires two R Markdown scripts. The first R Markdown, extracts
the unique list of parameters required to creare each report, which in this example 
are the unique species and location names, passing these parameters onto the second 
R Markdown script, which then creates the report, splitting the report into child 
templates to create each of the sections within the report. In the example this 
produces a table of penguin measurements for each year.

## First R Markdown script

---
output: html_document
---

```{r}
library(palmerpenguins)
library(stringr)
library(dplyr)
library(purrr)
library(fs)
```

```{r}
dir_create(path(tempdir(), "reports"))
```

```{r}
run_report <- function(...) {

  penguin_details <- list(...)
  
  rmarkdown::render(input = "penguin_measurements_report.Rmd",
                    output_file = str_glue("{pluck(penguin_details, 'species')}_{pluck(penguin_details, 'island')}.html"),
                    output_dir = path(tempdir(), "reports"),
                    params = list(
                      species_name = pluck(penguin_details, "species"),
                      island_name = pluck(penguin_details, "island"))
  )
}
safe_run_report <- safely(run_report)
```

```{r}
penguin_details <- penguins %>% 
  select(species, island) %>% 
  distinct() 

penguin_details%>% 
  pmap(safe_run_report)
```

```{r eval=TRUE}
knitr::knit_exit()
```

## Second R Markdown script

---
title: ""
output: html_document
params:
  species_name: NA_character_
  island_name: NA_character_
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r echo = FALSE}
suppressPackageStartupMessages({
  library(store)
  suppressWarnings({
    library(palmerpenguins)
    library(dplyr)
    library(purrr)
    library(tidyr)
    library(stringr)
    library(gt)
    library(janitor)
  })
})
```

```{r echo = FALSE}
# Assign parameterized values
species_name <- params$species_name
island_name <- params$island_name

# Filter on parameterized values
penguin_data <- penguins %>% 
  filter(species == species_name, island == island_name) %>% 
  select(year, sex, body_mass_g, contains("mm")) %>% 
  drop_na()

# Get years
year_value <- penguin_data %>% 
  distinct(year) %>% 
  pull()
```

## `r species_name` penguins on `r island_name` island

The following table lists the body mass, bill and flipper measurements taken<br/> on
`r nrow(penguin_data)` `r species_name` penguins living on `r island_name` island between `r min(pull(penguin_data, year))` and `r max(pull(penguin_data, year))`.<br/> Penguins with missing measurements are not included.

```{r }
# table
table_measurements <- function(data){
  data %>% 
    gt() %>%
    tab_header(title = md(str_glue("**{species_name} penguins**")),
               subtitle = str_glue("{island_name} island")) %>% 
    cols_label(
      sex = html("Sex<br/><br/>"),
      body_mass_g = html("Body mass<br/>grams"),
      bill_length_mm = html("Bill length<br/>mm"),
      bill_depth_mm = html("Bill depth<br/>mm"),
      flipper_length_mm = html("Flipper length<br/>mm"),
    ) %>% 
    cols_align(
      align = "left",
      columns = everything()
    ) %>% 
    tab_options(
      heading.background.color = "#2C3E50",
      column_labels.font.weight = "bold",
      table.align = "left",
      table.width = pct(50),
      table.font.size = "smaller",
      data_row.padding = px(0)
    )
}
```

```{r echo=FALSE, results='asis'}
# get penguin measurements table for each year
# https://bookdown.org/yihui/rmarkdown-cookbook/child-document.html
child_template <- function(year_value) {
  knitr::knit_child(text = c(
    '#### **Penguin measurements taken during `r year_value`**',
    '',
    '```{r}',
    'penguin_data_year <- penguin_data %>%',
    '   filter(year == year_value) %>%',
    '   select(-year)',
    '',
    'penguin_data_year %>% table_measurements()',
    '```',
    '<br/>',
    ''
  ), envir = environment(), quiet = TRUE)
}
tables <- map(year_value, child_template)
cat(unlist(tables), sep = '\n')
```


